
/***********************************************************************************
 * Fichier: routes\web.php
 ***********************************************************************************/

<?php
// routes/web.php

use App\Backend\Controller\Administration\AdminDashboardController;
use App\Backend\Controller\Administration\ConfigurationController;
use App\Backend\Controller\Administration\SupervisionController;
use App\Backend\Controller\Administration\UtilisateurController;
use App\Backend\Controller\AssetController;
use App\Backend\Controller\AuthentificationController;
use App\Backend\Controller\Commission\CommissionDashboardController;
use App\Backend\Controller\Commission\WorkflowCommissionController;
use App\Backend\Controller\DashboardController;
use App\Backend\Controller\Etudiant\EtudiantDashboardController;
use App\Backend\Controller\Etudiant\ProfilEtudiantController;
use App\Backend\Controller\Etudiant\RapportController;
use App\Backend\Controller\HomeController;
use App\Backend\Controller\PersonnelAdministratif\PersonnelDashboardController;
use App\Backend\Controller\PersonnelAdministratif\ScolariteController;
use FastRoute\RouteCollector;

/**
 * Définit toutes les routes de l'application.
 * Ce fichier retourne une closure qui sera utilisée par le Router pour construire la collection de routes.
 *
 * @param RouteCollector $router L'instance du collecteur de routes de FastRoute.
 */
return function(RouteCollector $router) {
    // --- Routes Publiques et Authentification ---
    $router->addRoute('GET', '/', [HomeController::class, 'index']);
    $router->addRoute('GET', '/login', [AuthentificationController::class, 'showLoginForm']);
    $router->addRoute('POST', '/login', [AuthentificationController::class, 'login']);
    $router->addRoute('GET', '/logout', [AuthentificationController::class, 'logout']);
    $router->addRoute('GET', '/forgot-password', [AuthentificationController::class, 'showForgotPasswordForm']);
    $router->addRoute('POST', '/forgot-password', [AuthentificationController::class, 'handleForgotPassword']);
    $router->addRoute('GET', '/reset-password/{token}', [AuthentificationController::class, 'showResetPasswordForm']);
    $router->addRoute('POST', '/reset-password/{token}', [AuthentificationController::class, 'handleResetPassword']);
    $router->addRoute('GET', '/validate-email/{token}', [AuthentificationController::class, 'validateEmail']);

    // --- Routes Protégées (nécessitent une connexion) ---

    // Dashboard principal (point d'entrée après connexion)
    $router->addRoute('GET', '/dashboard', [DashboardController::class, 'index']);

    // --- Section Administration ---
    $router->addGroup('/admin', function (RouteCollector $r) {
        $r->addRoute('GET', '/dashboard', [AdminDashboardController::class, 'index']);
        $r->addRoute('GET', '/utilisateurs', [UtilisateurController::class, 'list']);
        $r->addRoute('POST', '/utilisateurs/creer', [UtilisateurController::class, 'create']);
        $r->addRoute('GET', '/utilisateurs/{id}', [UtilisateurController::class, 'show']);
        $r->addRoute('POST', '/utilisateurs/{id}/modifier', [UtilisateurController::class, 'update']);
        $r->addRoute('POST', '/utilisateurs/{id}/supprimer', [UtilisateurController::class, 'delete']);
        $r->addRoute('GET', '/configuration', [ConfigurationController::class, 'index']);
        $r->addRoute('POST', '/configuration', [ConfigurationController::class, 'save']);
        $r->addRoute('GET', '/supervision', [SupervisionController::class, 'index']);
    });

    // --- Section Étudiant ---
    $router->addGroup('/etudiant', function (RouteCollector $r) {
        $r->addRoute('GET', '/dashboard', [EtudiantDashboardController::class, 'index']);
        $r->addRoute('GET', '/profil', [ProfilEtudiantController::class, 'show']);
        $r->addRoute('POST', '/profil', [ProfilEtudiantController::class, 'update']);
        $r->addRoute('GET', '/rapport/redaction', [RapportController::class, 'edit']);
        $r->addRoute('POST', '/rapport/sauvegarder', [RapportController::class, 'save']);
        $r->addRoute('POST', '/rapport/soumettre', [RapportController::class, 'submit']);
    });

    // --- Section Commission ---
    $router->addGroup('/commission', function (RouteCollector $r) {
        $r->addRoute('GET', '/dashboard', [CommissionDashboardController::class, 'index']);
        $r->addRoute('GET', '/workflow', [WorkflowCommissionController::class, 'index']);
        $r->addRoute('POST', '/workflow/voter', [WorkflowCommissionController::class, 'vote']);
    });

    // --- Section Personnel Administratif ---
    $router->addGroup('/personnel', function (RouteCollector $r) {
        $r->addRoute('GET', '/dashboard', [PersonnelDashboardController::class, 'index']);
        $r->addRoute('GET', '/scolarite', [ScolariteController::class, 'index']);
        $r->addRoute('POST', '/scolarite/activer-compte', [ScolariteController::class, 'activateAccount']);
    });

    // --- Route pour servir les assets (CSS, JS, images) ---
    // Le pattern {filePath:.+} permet de capturer les chemins avec des sous-dossiers.
    $router->addRoute('GET', '/assets/{filePath:.+}', [AssetController::class, 'serve']);
};
